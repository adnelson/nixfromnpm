version: 2
jobs:
  build:
    docker:
      - image: nixos/nix
    steps:
      - checkout
      - run:
          name: Build
          command: nix-build release.nix -A nixfromnpm
      - run:
          name: Run help command
          command: result/bin/nixfromnpm --help >/dev/null
      - run:
          name: Build lodash
          command: |
            PATH=$(readlink result)/bin:$PATH
            PROJECT_DIR=$PWD
            cd $(mktemp -d)
            OUTPUT=$PWD/output
            nixfromnpm -o $OUTPUT -p lodash
            nix-build $OUTPUT -A nodePackages.lodash
            nixfromnpm -o $OUTPUT -p lodash
            if [[ $(ls $OUTPUT/nodePackages/lodash | wc -l) -ne 1 ]]; then
              echo "A new version of lodash shouldn't have been created" >&2
              exit 1
            fi
